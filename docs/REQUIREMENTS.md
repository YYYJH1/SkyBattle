# SkyBattle - 无人机空战模拟器 需求文档

> 版本: v1.0  
> 作者: Jiahao You  
> 日期: 2026-01-08

---

## 目录

1. [项目概述](#1-项目概述)
2. [功能需求](#2-功能需求)
3. [技术架构](#3-技术架构)
4. [环境设计](#4-环境设计)
5. [算法设计](#5-算法设计)
6. [API 设计](#6-api-设计)
7. [前端设计](#7-前端设计)
8. [开发计划](#9-开发计划)

---

## 1. 项目概述

### 1.1 项目背景

**SkyBattle** 是一个基于多智能体强化学习（MARL）的无人机空战模拟器。项目将学术研究中的 UAV 轨迹优化和 MARL 技术转化为一个有趣的、可交互的游戏化平台。

### 1.2 项目目标

| 目标类型 | 描述 |
|----------|------|
| **技术目标** | 展示 MARL 在对抗性多智能体场景中的应用 |
| **娱乐目标** | 提供有趣的人机对战和 AI 观战体验 |
| **教育目标** | 可视化 AI 决策过程，帮助理解强化学习 |
| **社区目标** | 支持用户上传自训练模型，建立竞技社区 |

### 1.3 目标用户

1. **AI/RL 研究者** - 使用环境进行算法研究
2. **游戏玩家** - 体验人机对战的乐趣
3. **学生/教育者** - 学习和教授 MARL 概念
4. **开发者** - 基于平台开发新功能

### 1.4 核心价值

```
┌─────────────────────────────────────────────────────────────┐
│                    SkyBattle 核心价值                        │
├─────────────────────────────────────────────────────────────┤
│   🎮 趣味性          🔬 研究价值         📚 教育意义        │
│   ─────────         ───────────         ───────────        │
│   游戏化体验         Gymnasium兼容       可视化决策过程     │
│   人机对战           算法可扩展          交互式学习         │
│   竞技排行           论文基准测试        开源社区           │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 功能需求

### 2.1 游戏模式

#### 2.1.1 AI vs AI 观战模式

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 自动对战 | 两队 AI 自动进行空战 | P0 |
| 速度控制 | 0.5x / 1x / 2x / 4x 播放速度 | P1 |
| 暂停/继续 | 随时暂停观察局势 | P0 |
| 镜头切换 | 自由视角 / 跟随视角 / 俯视视角 | P1 |

#### 2.1.2 人机对战模式

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 玩家控制 | 键盘控制一架无人机 | P0 |
| 难度选择 | 简单 / 普通 / 困难 | P1 |
| AI 队友 | 玩家可选择带 AI 队友 | P2 |

#### 2.1.3 训练模式

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 自定义训练 | 配置训练参数启动训练 | P0 |
| 实时监控 | 训练曲线实时展示 | P0 |
| 检查点保存 | 定期保存训练检查点 | P0 |

### 2.2 游戏机制

#### 2.2.1 战斗系统

```
┌─────────────────────────────────────────────────────────────┐
│                       战斗系统设计                           │
├─────────────────────────────────────────────────────────────┤
│  【攻击机制】                                                │
│  ├── 主武器：机炮（近距离，高伤害，需要瞄准）                 │
│  ├── 副武器：导弹（中距离，追踪，有冷却）                     │
│  └── 特殊：干扰弹（躲避导弹追踪）                            │
│                                                             │
│  【防御机制】                                                │
│  ├── 护盾值：可再生的防御层                                  │
│  ├── 生命值：核心血量，归零则坠毁                            │
│  └── 闪避：高速机动可降低被命中概率                          │
│                                                             │
│  【能量系统】                                                │
│  ├── 能量槽：用于加速、导弹、干扰弹                          │
│  └── 自动回复：低速飞行时回复更快                            │
└─────────────────────────────────────────────────────────────┘
```

#### 2.2.2 无人机属性

| 属性 | 描述 | 范围 |
|------|------|------|
| HP（生命值） | 无人机血量 | 0-100 |
| Shield（护盾） | 可再生护盾 | 0-50 |
| Energy（能量） | 技能能量 | 0-100 |
| Speed（速度） | 当前速度 | 0-200 m/s |
| Ammo（弹药） | 机炮弹药 | 0-500 |
| Missiles（导弹） | 导弹数量 | 0-4 |

---

## 3. 技术架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                         SkyBattle 技术架构                           │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      Frontend (Vue 3)                        │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐ │   │
│  │  │  Three.js │  │  Control  │  │   Stats   │  │  Training │ │   │
│  │  │  3D Scene │  │   Panel   │  │   Panel   │  │   Charts  │ │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘ │   │
│  └──────────────────────────┬──────────────────────────────────┘   │
│                             │ WebSocket / REST                      │
│  ┌──────────────────────────▼──────────────────────────────────┐   │
│  │                      Backend (FastAPI)                       │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐ │   │
│  │  │    API    │  │ WebSocket │  │   Game    │  │  Training │ │   │
│  │  │  Routes   │  │  Handler  │  │  Manager  │  │  Manager  │ │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘ │   │
│  └──────────────────────────┬──────────────────────────────────┘   │
│  ┌──────────────────────────▼──────────────────────────────────┐   │
│  │                      Core Engine                             │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐ │   │
│  │  │  Combat   │  │   Drone   │  │  Physics  │  │   MAPPO   │ │   │
│  │  │    Env    │  │   Model   │  │  Engine   │  │   Agent   │ │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘ │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 技术栈

| 层级 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **前端** | Vue 3 | 3.4+ | UI 框架 |
| | Three.js | r160+ | 3D 渲染 |
| | Pinia | 2.x | 状态管理 |
| | Chart.js | 4.x | 图表展示 |
| **后端** | FastAPI | 0.109+ | Web 框架 |
| | Uvicorn | 0.27+ | ASGI 服务器 |
| | WebSocket | - | 实时通信 |
| **核心** | Python | 3.10+ | 主语言 |
| | PyTorch | 2.1+ | 深度学习 |
| | Gymnasium | 0.29+ | RL 环境 |

---

## 4. 环境设计

### 4.1 状态空间 (Observation Space)

每个无人机的观测包含以下信息：

#### 4.1.1 自身状态 (Self State) - 13 维

| 索引 | 属性 | 维度 | 描述 |
|------|------|------|------|
| 0-2 | position | 3 | x, y, z 位置 |
| 3-5 | velocity | 3 | 速度向量 |
| 6-8 | orientation | 3 | 欧拉角 |
| 9-12 | status | 4 | hp, shield, energy, ammo |

#### 4.1.2 总观测维度

```
观测维度 = 自身(13) + 敌人(N × 10) + 队友((N-1) × 8) + 环境(6)

示例 (3v3 对战):
观测维度 = 13 + 3×10 + 2×8 + 6 = 65 维
```

### 4.2 动作空间 (Action Space)

采用**混合动作空间** (Hybrid Action Space)：

#### 4.2.1 离散动作 (Discrete Actions)

| 动作 ID | 名称 | 描述 |
|---------|------|------|
| 0 | IDLE | 保持当前状态 |
| 1 | FIRE_GUN | 发射机炮 |
| 2 | FIRE_MISSILE | 发射导弹 |
| 3 | DEPLOY_FLARE | 释放干扰弹 |
| 4 | BOOST | 加速冲刺 |

#### 4.2.2 连续动作 (Continuous Actions)

| 索引 | 名称 | 范围 | 描述 |
|------|------|------|------|
| 0 | throttle | [-1, 1] | 油门 |
| 1 | pitch | [-1, 1] | 俯仰角速度 |
| 2 | yaw | [-1, 1] | 偏航角速度 |
| 3 | roll | [-1, 1] | 翻滚角速度 |

### 4.3 奖励函数 (Reward Function)

```python
reward = (
    + damage_dealt × 0.5          # 造成伤害
    + kills × 50.0                # 击杀奖励
    - damage_taken × 0.3          # 受伤惩罚
    - death × 30.0                # 死亡惩罚
    + survival × 0.1              # 存活奖励
    + team_reward × 0.3           # 团队奖励
)
```

---

## 5. 算法设计

### 5.1 MAPPO 算法

Multi-Agent Proximal Policy Optimization (MAPPO) 采用 **CTDE** 范式：

```
┌─────────────────────────────────────────────────────────────┐
│                     MAPPO Architecture                       │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Agent 1   │  │   Agent 2   │  │   Agent 3   │         │
│  │   (Actor)   │  │   (Actor)   │  │   (Actor)   │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
│         │ local obs      │ local obs      │ local obs      │
│         ▼                ▼                ▼                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Shared Centralized Critic               │   │
│  │                  (Global State)                      │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 训练超参数

| 参数 | 默认值 | 描述 |
|------|--------|------|
| `lr_actor` | 3e-4 | Actor 学习率 |
| `lr_critic` | 5e-4 | Critic 学习率 |
| `gamma` | 0.99 | 折扣因子 |
| `gae_lambda` | 0.95 | GAE 参数 |
| `clip_ratio` | 0.2 | PPO clip 范围 |
| `entropy_coef` | 0.01 | 熵正则化系数 |
| `n_epochs` | 10 | PPO 更新轮数 |
| `batch_size` | 256 | 批大小 |

---

## 6. API 设计

### 6.1 REST API

| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/v1/games` | POST | 创建游戏 |
| `/api/v1/games/{id}` | GET | 获取游戏状态 |
| `/api/v1/games/{id}/control` | POST | 控制游戏 |
| `/api/v1/training` | POST | 启动训练 |

### 6.2 WebSocket

| 端点 | 描述 |
|------|------|
| `/ws/game/{id}` | 游戏实时状态 |
| `/ws/training/{id}` | 训练实时数据 |

---

## 7. 前端设计

### 7.1 页面结构

| 页面 | 路由 | 描述 |
|------|------|------|
| 主页 | `/` | 模式选择菜单 |
| 游戏 | `/game/:id` | 3D 战斗场景 |
| 训练 | `/training` | 训练配置和监控 |

### 7.2 UI 设计风格

| 元素 | 规范 |
|------|------|
| **主色调** | 深空蓝 (#0a0e17) + 霓虹青 (#00f0ff) |
| **辅助色** | 红队 (#ff4757) / 蓝队 (#3b82f6) |
| **字体** | Orbitron (标题) / Space Grotesk (正文) |
| **风格** | 赛博朋克、航空主题 |

---

## 8. 开发计划

| 阶段 | 时间 | 目标 |
|------|------|------|
| M1 | Week 1-2 | 环境核心 |
| M2 | Week 2-3 | MAPPO 算法 |
| M3 | Week 3-4 | 后端 API |
| M4 | Week 4-5 | 前端基础 |
| M5 | Week 5-6 | 集成测试 |
| M6 | Week 6-7 | 优化发布 |

---

## 附录

### A. 参考资料

1. [MAPPO 论文](https://arxiv.org/abs/2103.01955)
2. [Gymnasium 文档](https://gymnasium.farama.org/)
3. [Three.js 文档](https://threejs.org/docs/)
4. [FastAPI 文档](https://fastapi.tiangolo.com/)

---

*文档结束*
